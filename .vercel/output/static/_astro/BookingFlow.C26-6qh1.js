import{j as t}from"./jsx-runtime.D_zvdyIk.js";import{r as s}from"./index.DiEladB3.js";function D(r){const u=r.trim(),n=u.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(n)return`${n[1]}-${n[2]}-${n[3]}`;const o=u.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);if(!o)return null;const a=Number(o[1]),b=Number(o[2]),i=Number(o[3]),m=new Date(Date.UTC(i,b-1,a));return m.getUTCFullYear()!==i||m.getUTCMonth()!==b-1||m.getUTCDate()!==a?null:`${o[3]}-${o[2]}-${o[1]}`}function L({services:r,barbers:u,mode:n="create",token:o=""}){const[a,b]=s.useState(r[0]?.id??""),[i,m]=s.useState(u[0]?.id??""),[h,P]=s.useState(new Date().toISOString().slice(0,10)),[x,y]=s.useState([]),[c,p]=s.useState(""),[g,T]=s.useState(""),[f,B]=s.useState(""),[v,E]=s.useState(""),[k,l]=s.useState("");s.useEffect(()=>{if(!a||!i||!h)return;const e=D(h);if(!e){y([]),p("");return}fetch(`/api/availability?serviceId=${a}&barberId=${i}&date=${e}`).then(d=>d.json()).then(d=>{y(d.slots??[]),p("")})},[a,i,h]);const S=s.useMemo(()=>r.find(e=>e.id===a),[a,r]);async function I(){if(l(""),!a||!i){l("Please choose a service and barber.");return}const e=D(h);if(!e){l("Please choose a valid date.");return}if(!c){l("Please select an available time.");return}if(n==="reschedule"){if(!o){l("Missing reschedule token. Please use the manage link from your email.");return}const w=await fetch("/api/bookings/reschedule",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({token:o,serviceId:a,barberId:i,date:e,time:c})}),j=await w.json().catch(()=>({}));if(!w.ok){l(j.error||"Unable to reschedule booking.");return}const U=j.booking?.startAt?new Date(j.booking.startAt).toLocaleString("en-GB",{timeZone:"Europe/London"}):`${e} ${c}`;l(`Booking rescheduled successfully. New time: ${U}.`);return}const d=g.trim(),N=f.trim(),C=v.trim();if(!d||!N){l("Please provide your full name and email.");return}const M={serviceId:a,barberId:i,date:e,time:c,fullName:d,email:N,...C?{phone:C}:{}},$=await fetch("/api/bookings/create",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(M)}),F=await $.json().catch(()=>({}));l($.ok?"Booking created. Check email for confirmation magic link.":F.error||"Unable to create booking.")}return t.jsxs("section",{className:"surface booking-shell",children:[t.jsx("h1",{children:n==="reschedule"?"Reschedule Booking":"Book Now"}),t.jsxs("p",{className:"muted",children:["Timezone: Europe/London â€¢ ",n==="reschedule"?"Choose a new slot and submit once.":"Confirmation required by email."]}),t.jsx("label",{children:"Service"}),t.jsx("select",{value:a,onChange:e=>b(e.target.value),children:r.map(e=>t.jsxs("option",{value:e.id,children:[e.name," (",e.durationMinutes," min)"]},e.id))}),t.jsx("label",{children:"Barber"}),t.jsx("select",{value:i,onChange:e=>m(e.target.value),children:u.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))}),t.jsx("label",{children:"Date"}),t.jsx("input",{type:"date",value:h,onChange:e=>P(e.target.value)}),t.jsxs("label",{children:["Available times ",S?`for ${S.name}`:""]}),t.jsxs("div",{className:"slot-grid",children:[x.map(e=>t.jsx("button",{type:"button",className:c===e?"btn btn--primary":"btn btn--secondary",onClick:()=>p(e),children:e},e)),x.length===0&&t.jsx("p",{className:"muted",children:"No slots available for this date."})]}),n==="create"&&t.jsxs(t.Fragment,{children:[t.jsx("label",{children:"Full name"}),t.jsx("input",{value:g,onChange:e=>T(e.target.value)}),t.jsx("label",{children:"Email"}),t.jsx("input",{type:"email",value:f,onChange:e=>B(e.target.value)}),t.jsx("label",{children:"Phone (optional)"}),t.jsx("input",{value:v,onChange:e=>E(e.target.value)})]}),t.jsx("button",{type:"button",className:"btn btn--primary",disabled:!c||n==="create"&&(!g||!f),onClick:I,children:n==="reschedule"?"Reschedule booking":"Create booking"}),k&&t.jsx("p",{children:k})]})}export{L as default};
