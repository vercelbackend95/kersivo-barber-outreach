---
import MainLayout from '@/layouts/MainLayout.astro';
import { prisma } from '../lib/db/client';
import { resolveShopId } from '../lib/db/shopScope';
import { formatGbp } from '../lib/shop/money';


const shopId = await resolveShopId();
const products = await prisma.product.findMany({
  where: { shopId, active: true },
  orderBy: [{ featured: 'desc' }, { sortOrder: 'asc' }, { updatedAt: 'desc' }]
});


---

<MainLayout title="Shop | Kersivo Barber Outreach">
  <main class="container shop-page">
    <header class="shop-header">
      <p class="shop-eyebrow">Demo shop</p>
      <h1>Products</h1>
      <p class="muted">Add products to cart and confirm pickup orders in GBP.</p>
    </header>

    <section class="shop-grid" aria-label="Products">
      {products.length === 0 ? (
        <article class="shop-card">
          <h2>No products yet</h2>
          <p class="muted">Products added in Admin â†’ Shop will appear here.</p>
        </article>
      ) : products.map((product) => (
        <article class="shop-card" key={product.id}>
          {product.imageUrl ? <img src={product.imageUrl} alt={product.name} class="shop-image" loading="lazy" /> : null}
          <div class="shop-card-body">
            <div class="shop-card-head">
              <h2>{product.name}</h2>
              <p class="shop-price">{formatGbp(product.pricePence)}</p>

            </div>
            {product.description ? <p class="muted">{product.description}</p> : null}
            <button
              type="button"
              class="btn btn--primary"
              data-add-to-cart
              data-product-id={product.id}
              data-product-name={product.name}
              data-product-price-pence={String(product.pricePence)}
              data-product-image-url={product.imageUrl ?? ''}
            >
              Add to cart
            </button>
          </div>
        </article>
      ))}
    </section>
  </main>
</MainLayout>

