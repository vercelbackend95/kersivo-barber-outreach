---
import '../../styles/tokens.css';
import '../../styles/global.css';
import '../../styles/components/booking.css';

const token = Astro.url.searchParams.get('token') ?? '';
let message = 'Missing cancellation link. Please use the link from your booking email.';
let isError = true;

if (token) {
  try {
    const apiResponse = await fetch(new URL('/api/bookings/cancel', Astro.url), {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ token })
    });

    const payload = await apiResponse.json();

    if (apiResponse.ok) {
      message = payload?.message ?? 'Your booking has been cancelled successfully.';
      isError = false;
    } else {
      message = payload?.error ?? 'We could not cancel this booking. Please contact the shop for help.';
    }
  } catch {
    message = 'We could not cancel this booking right now. Please try again shortly.';
  }
}
---
<html lang="en">
  <body>
    <main class="container page-wrap">
      <section class="surface booking-shell">
        <h1>Cancel booking</h1>
        <p>{message}</p>
        {isError && <p class="muted">If this keeps happening, please contact the barbershop directly.</p>}
      </section>
    </main>
  </body>
</html>