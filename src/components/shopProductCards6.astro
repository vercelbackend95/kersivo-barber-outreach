---
import { prisma } from '../lib/db/client';
import { resolveShopId } from '../lib/db/shopScope';
import { formatGbp } from '../lib/shop/money';

const shopId = await resolveShopId();
const products = await prisma.product.findMany({
  where: { shopId, active: true },
  orderBy: [{ featured: 'desc' }, { sortOrder: 'asc' }, { updatedAt: 'desc' }],
  take: 3
});

---

<section class="shop6" aria-labelledby="shop6-title">
  <div class="container shop6__container">
    <div class="shop6__header">
      <p class="shop6__eyebrow">Shop</p>
      <h2 id="shop6-title">Barber Products Ready for Pickup</h2>
      <p>These featured products are synced with Admin → Shop → Products.</p>

    </div>

    <ul class="shop6__grid">
      {products.length === 0 ? (
        <li class="shop6__item">
          <article class="shop6__card">
            <div class="shop6__content">
              <h3>No products yet</h3>
              <p class="muted">Add products in Admin to publish them on the landing page and /shop.</p>
            </div>
          </article>
        </li>
      ) : products.map((product, index) => (

        <li class="shop6__item" key={`${product.name}-${index}`}>
          <article class="shop6__card">
            {product.imageUrl ? (
              <img src={product.imageUrl} alt={product.name} loading="lazy" class="shop6__image" />
            ) : (
              <div class="shop6__image shop6__image--placeholder" aria-hidden="true"></div>
            )}


            <div class="shop6__content">
              <p class="shop6__collection">Featured item</p>
              <h3>{product.name}</h3>

              <div class="shop6__footer">
               <p class="shop6__price">{formatGbp(product.pricePence)}</p>

                <div class="shop6__actions">
                  <button
                    class="btn btn--primary"
                    type="button"
                    data-add-to-cart
                    data-product-id={product.id}
                    data-product-name={product.name}
                    data-product-price-pence={String(product.pricePence)}
                    data-product-image-url={product.imageUrl ?? ''}
                  >
                    Add to cart
                  </button>

                  <a class="btn btn--ghost" href="/shop">View in shop</a>

                </div>
              </div>
            </div>
          </article>
        </li>
      ))}
    </ul>
  </div>
</section>
