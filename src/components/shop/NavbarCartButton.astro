---
// src/components/shop/NavbarCartButton.astro
type Props = {
  class?: string;
};

const { class: className = '' } = Astro.props;
---

<button type="button" class={className} aria-label="Open cart" data-navbar-cart-button>
  <span aria-hidden="true">ðŸ›’</span>
  <span>Cart</span>
  <span class="navbar17__cart-badge is-empty" data-navbar-cart-badge>0</span>
</button>

<script type="module">
  import { getItemCount, openCart } from '@/lib/shop/cartStore';

  const renderCount = () => {
    const count = getItemCount();
    const badges = Array.from(document.querySelectorAll('[data-navbar-cart-badge]'));

    badges.forEach((badge) => {
      badge.textContent = String(count);
      badge.classList.toggle('is-empty', count === 0);
    });
  };

  const bindCartButtons = () => {
    const cartButtons = Array.from(document.querySelectorAll('[data-navbar-cart-button]'));

    cartButtons.forEach((button) => {
      if (!(button instanceof HTMLButtonElement)) {
        return;
      }

      if (button.dataset.cartSyncBound === 'true') {
        return;
      }

      button.dataset.cartSyncBound = 'true';
      button.addEventListener('click', () => {
        openCart();
      });
    });
  };

  const refreshNavbarCart = () => {
    bindCartButtons();
    renderCount();
  };

  refreshNavbarCart();
  document.addEventListener('astro:page-load', refreshNavbarCart);
  document.addEventListener('astro:after-swap', refreshNavbarCart);
</script>
