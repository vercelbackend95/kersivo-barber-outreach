---
// src/components/shop/NavbarCartButton.astro
type Props = {
  class?: string;
};

const { class: className = '' } = Astro.props;
---

<button type="button" class={className} aria-label="Open cart" data-navbar-cart-button>
  <span aria-hidden="true">ðŸ›’</span>
  <span>Cart</span>
  <span class="navbar17__cart-badge is-empty" data-navbar-cart-badge>0</span>
</button>

<script type="module">
  const CART_OPEN_REQUEST_EVENT = 'kersivo:cart-open-request';

  const forceOpenDrawerClass = () => {
    const drawers = Array.from(document.querySelectorAll('.cart-drawer'));

    drawers.forEach((drawer) => {
      if (!(drawer instanceof HTMLElement)) {
        return;
      }

      drawer.classList.add('cart-drawer--open');
      drawer.setAttribute('aria-hidden', 'false');
    });
  };

  const bindCartButtons = () => {
    const cartButtons = Array.from(document.querySelectorAll('[data-navbar-cart-button]'));

    cartButtons.forEach((button) => {
      if (!(button instanceof HTMLButtonElement)) {
        return;
      }

      if (button.dataset.cartSyncBound === 'true') {
        return;
      }

      button.dataset.cartSyncBound = 'true';
      button.addEventListener('click', () => {
        window.dispatchEvent(new CustomEvent(CART_OPEN_REQUEST_EVENT));
        forceOpenDrawerClass();
      });
    });
  };

  const refreshNavbarCart = () => {
    bindCartButtons();
  };

  refreshNavbarCart();
  document.addEventListener('astro:page-load', refreshNavbarCart);
  document.addEventListener('astro:after-swap', refreshNavbarCart);
</script>
