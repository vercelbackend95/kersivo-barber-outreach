---
const { products = [] } = Astro.props;
---

<aside class="cart-drawer" data-cart-drawer>
  <button type="button" class="btn btn--ghost cart-drawer__close" data-cart-close>Close</button>
  <h2>Cart</h2>
  <div class="cart-items" data-cart-items></div>

  <label class="cart-email-label" for="shop-cart-email">Email for pickup updates</label>
  <input id="shop-cart-email" type="email" autocomplete="email" placeholder="you@example.com" class="cart-email-input" data-cart-email />

  <p class="cart-subtotal">Subtotal: <strong data-cart-subtotal>£0.00</strong></p>
  <button type="button" class="btn btn--primary" data-cart-checkout>Checkout (Pickup)</button>
  <p class="muted" data-cart-feedback></p>
</aside>

<script type="module" define:vars={{ products }}>
  import { addItem, clearCart, closeCart, openCart, readCart, removeItem, setQty, CART_CLOSE_EVENT, CART_OPEN_EVENT, CART_UPDATED_EVENT } from '@/lib/shop/cartStore';
  const productsMap = new Map(products.map((product) => [product.id, product]));
  const drawer = document.querySelector('[data-cart-drawer]');
  const cartItemsContainer = drawer?.querySelector('[data-cart-items]');
  const subtotalEl = drawer?.querySelector('[data-cart-subtotal]');
  const checkoutButton = drawer?.querySelector('[data-cart-checkout]');
  const feedbackEl = drawer?.querySelector('[data-cart-feedback]');
  const customerEmailEl = drawer?.querySelector('[data-cart-email]');

  if (!drawer || !cartItemsContainer || !subtotalEl || !checkoutButton || !feedbackEl || !customerEmailEl) {
    throw new Error('Cart drawer is missing required elements.');
  }

  const formatGbp = (pence) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(pence / 100);
  const isEmailValid = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

  function setOpenState(open) {
    drawer.classList.toggle('cart-drawer--open', open);
    drawer.setAttribute('aria-hidden', open ? 'false' : 'true');
  }

  function renderCart() {
    const cart = readCart();
    let subtotal = 0;

    if (cart.length === 0) {
      cartItemsContainer.innerHTML = '<p class="muted">Your cart is empty.</p>';
    } else {
      cartItemsContainer.innerHTML = '';
      for (const item of cart) {
        const product = productsMap.get(item.productId);
        if (!product) continue;

        const lineTotal = product.pricePence * item.quantity;
        subtotal += lineTotal;
        const row = document.createElement('div');
        row.className = 'cart-row';
        row.innerHTML = `
          <div>
            <p class="cart-item-name">${product.name}</p>
            <p class="muted">${formatGbp(product.pricePence)} each</p>
          </div>
          <div class="cart-row-actions">
            <button type="button" class="btn btn--ghost" data-minus="${item.productId}">-</button>
            <span>${item.quantity}</span>
            <button type="button" class="btn btn--ghost" data-plus="${item.productId}">+</button>
            <button type="button" class="btn btn--secondary" data-remove="${item.productId}">Remove</button>
          </div>
        `;
        cartItemsContainer.append(row);
      }
    }

    subtotalEl.textContent = formatGbp(subtotal);
    checkoutButton.disabled = cart.length === 0 || !isEmailValid(customerEmailEl.value.trim());
  }

  function setFeedback(message) {
    feedbackEl.textContent = message;
  }

  document.querySelectorAll('[data-add-to-cart]').forEach((button) => {
    button.addEventListener('click', () => {
      const productId = button.getAttribute('data-add-to-cart');
      if (!productId) return;
      addItem(productId, 1);
      openCart();
      setFeedback('');
    });
  });

  cartItemsContainer.addEventListener('click', (event) => {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;
    if (target.dataset.plus) setQty(target.dataset.plus, (readCart().find((entry) => entry.productId === target.dataset.plus)?.quantity ?? 0) + 1);
    if (target.dataset.minus) setQty(target.dataset.minus, (readCart().find((entry) => entry.productId === target.dataset.minus)?.quantity ?? 0) - 1);
    if (target.dataset.remove) removeItem(target.dataset.remove);
  });

  checkoutButton.addEventListener('click', async () => {
    setFeedback('');
    const customerEmail = customerEmailEl.value.trim().toLowerCase();
    const items = readCart();

    if (items.length === 0) {
      setFeedback('Your cart is empty.');
      return;
    }
    if (!isEmailValid(customerEmail)) {
      setFeedback('Please enter a valid email address.');
      return;
    }

    checkoutButton.disabled = true;
    checkoutButton.textContent = 'Processing…';

    try {
      const response = await fetch('/api/shop/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customerEmail, items })
      });
      const payload = await response.json();
      if (!response.ok) throw new Error(payload.error || 'Checkout failed.');

      clearCart();
      setFeedback('Order created. Ready for in-store pickup.');
      window.location.href = `/shop/success?orderId=${encodeURIComponent(payload.orderId)}`;
    } catch (error) {
      setFeedback(error instanceof Error ? error.message : 'Checkout failed.');
    } finally {
      checkoutButton.disabled = false;
      checkoutButton.textContent = 'Checkout (Pickup)';
      renderCart();
    }
  });

  customerEmailEl.addEventListener('input', () => {
    renderCart();
  });

  drawer.querySelector('[data-cart-close]')?.addEventListener('click', () => closeCart());
  window.addEventListener(CART_OPEN_EVENT, () => setOpenState(true));
  window.addEventListener(CART_CLOSE_EVENT, () => setOpenState(false));
  window.addEventListener(CART_UPDATED_EVENT, renderCart);
  window.addEventListener('storage', renderCart);

  renderCart();
  setOpenState(false);
</script>
