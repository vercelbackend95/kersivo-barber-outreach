---
import BookingFlow from '../../components/booking/BookingFlow';
import '../../styles/tokens.css';
import '../../styles/global.css';
import '../../styles/components/booking.css';
import '../../styles/components/buttons.css';
import { prisma } from '../../lib/db/client';
import { getRescheduleTokenStatus } from '../../lib/booking/service';

const token = Astro.url.searchParams.get('token') ?? '';
const tokenStatus = token ? await getRescheduleTokenStatus(token) : { valid: false as const, message: 'Missing token.' };
const [services, barbers] = await Promise.all([
  prisma.service.findMany({ where: { active: true }, orderBy: { createdAt: 'asc' } }),
  prisma.barber.findMany({ where: { active: true }, orderBy: { createdAt: 'asc' } })
]);
---
<html lang="en">
  <body>
    <main class="container page-wrap">
      <section class="surface booking-shell">
        <h1>Reschedule booking</h1>
        {
          tokenStatus.valid ? (
            <>
            <p class="muted">Pick a new slot to update your confirmed booking.</p>
              <BookingFlow client:load mode="reschedule" token={token} services={services} barbers={barbers} />
            </>
          ) : (
            <p>{tokenStatus.message}</p>
          )
        }
      </section>
    </main>
  </body>
</html>
